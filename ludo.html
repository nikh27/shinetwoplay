<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ludo Clash - 2 Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .board-grid {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
            width: 100%;
            aspect-ratio: 1;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-color: #f8fafc;
        }
        .cell {
            border: 0.5px solid rgba(148, 163, 184, 0.4);
        }
        .piece {
            transition: left 0.2s linear, top 0.2s linear, transform 0.2s ease-out;
            z-index: 20;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        }
        .piece.highlight {
            animation: pulse-glow 1.5s infinite;
            cursor: pointer;
            z-index: 30;
        }
        .piece.highlight:hover {
            transform: scale(1.2) !important;
        }
        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 6px #fbbf24) brightness(1); }
            50% { filter: drop-shadow(0 0 16px #f59e0b) brightness(1.3); }
        }

        @keyframes border-pulse {
            0% { border-color: rgba(255,255,255,0.2); }
            50% { border-color: rgba(255,255,255,0.8); }
            100% { border-color: rgba(255,255,255,0.2); }
        }
        .active-panel {
            animation: border-pulse 1.5s infinite;
        }

        /* ===== 3D DICE ===== */
        .dice-scene {
            width: 48px;
            height: 48px;
            perspective: 300px;
        }
        @media (min-width: 768px) {
            .dice-scene { width: 84px; height: 84px; perspective: 500px; }
        }

        .dice-cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        .dice-cube.rolling {
            animation: dice-tumble 0.65s cubic-bezier(0.2, 0.8, 0.3, 1);
        }

        @keyframes dice-tumble {
            0%   { transform: rotateX(20deg) rotateY(0deg) scale(0.9); }
            10%  { transform: rotateX(180deg) rotateY(-90deg) scale(1.05); }
            25%  { transform: rotateX(350deg) rotateY(200deg) rotateZ(-40deg) scale(1.1); }
            40%  { transform: rotateX(520deg) rotateY(-150deg) rotateZ(60deg) scale(1.08); }
            55%  { transform: rotateX(680deg) rotateY(280deg) rotateZ(-20deg) scale(1.04); }
            70%  { transform: rotateX(800deg) rotateY(-100deg) rotateZ(30deg) scale(1.02); }
            85%  { transform: rotateX(900deg) rotateY(50deg) rotateZ(-10deg) scale(1.0); }
            100% { transform: rotateX(1000deg) rotateY(0deg) rotateZ(0deg) scale(1.0); }
        }

        .dice-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 18%;
            display: grid;
            padding: 17%;
            box-sizing: border-box;
            backface-visibility: visible; /* Changed to visible to ensure faces don't flicker out */
        }

        .dice-face--light {
            background: linear-gradient(145deg, #ffffff 0%, #f5f5f5 40%, #e8e8e8 100%);
            box-shadow: inset 0 2px 8px rgba(255,255,255,0.9), inset 0 -3px 8px rgba(0,0,0,0.12);
            border: 1.5px solid rgba(0,0,0,0.06);
        }

        .dice-pip {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 38% 38%, #666, #1a1a1a 70%);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.25), 0 1px 3px rgba(0,0,0,0.4);
        }

        /* All faces use 3x3 grid */
        .dice-face { grid-template: 1fr 1fr 1fr / 1fr 1fr 1fr; gap: 6%; }

        /* Face positions - using fixed pixel values (24px for 48px scene, 42px for 84px scene) */
        .dice-face-1 { transform: rotateY(0deg) translateZ(24px); }
        .dice-face-2 { transform: rotateY(90deg) translateZ(24px); }
        .dice-face-3 { transform: rotateX(90deg) translateZ(24px); }
        .dice-face-4 { transform: rotateX(-90deg) translateZ(24px); }
        .dice-face-5 { transform: rotateY(-90deg) translateZ(24px); }
        .dice-face-6 { transform: rotateY(180deg) translateZ(24px); }

        @media (min-width: 768px) {
            .dice-face-1 { transform: rotateY(0deg) translateZ(42px); }
            .dice-face-2 { transform: rotateY(90deg) translateZ(42px); }
            .dice-face-3 { transform: rotateX(90deg) translateZ(42px); }
            .dice-face-4 { transform: rotateX(-90deg) translateZ(42px); }
            .dice-face-5 { transform: rotateY(-90deg) translateZ(42px); }
            .dice-face-6 { transform: rotateY(180deg) translateZ(42px); }
        }

        /* Show transforms to bring each face forward */
        .dice-show-1 { transform: rotateY(0deg)    rotateX(0deg); }
        .dice-show-2 { transform: rotateY(-90deg)   rotateX(0deg); }
        .dice-show-3 { transform: rotateX(-90deg)   rotateY(0deg); }
        .dice-show-4 { transform: rotateX(90deg)    rotateY(0deg); }
        .dice-show-5 { transform: rotateY(90deg)    rotateX(0deg); }
        .dice-show-6 { transform: rotateY(180deg)   rotateX(0deg); }

        /* Bounce on landing */
        .dice-cube.landed {
            animation: dice-land 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes dice-land {
            0%   { transform: var(--land-transform) scale(1.12); }
            50%  { transform: var(--land-transform) scale(0.94); }
            100% { transform: var(--land-transform) scale(1); }
        }

        /* Shadow under dice */
        .dice-shadow {
            width: 55%;
            height: 10px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.4) 0%, transparent 70%);
            border-radius: 50%;
            margin: 4px auto 0;
            transition: all 0.3s;
        }
        .dice-shadow.rolling {
            width: 35%;
            opacity: 0.3;
            transform: translateY(-4px);
        }

        /* Player glow ring around dice */
        .dice-glow-ring {
            position: absolute;
            inset: -8px;
            border-radius: 24%;
            opacity: 0;
            transition: opacity 0.4s, box-shadow 0.4s;
            pointer-events: none;
            z-index: -1;
        }
        .dice-glow-ring.active {
            opacity: 1;
        }

        /* Pip color override for player on result */
        .dice-pip.pip-red {
            background: radial-gradient(circle at 38% 38%, #f87171, #b91c1c 70%);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 1px 3px rgba(185, 28, 28, 0.5);
        }
        .dice-pip.pip-blue {
            background: radial-gradient(circle at 38% 38%, #60a5fa, #1d4ed8 70%);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 1px 3px rgba(29, 78, 216, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center justify-start font-sans p-2 overflow-hidden selection:bg-transparent">

    <!-- Top Header / Status -->
    <div class="text-center w-full mt-2 mb-4">
        <div class="bg-gray-800/80 backdrop-blur-md rounded-full inline-block px-6 py-2 border border-gray-700 shadow-lg">
            <p id="game-status" class="text-lg md:text-xl font-bold text-yellow-400">Loading Game...</p>
        </div>
    </div>

    <!-- Main Game Area (Board) -->
    <div class="relative w-full max-w-[340px] md:max-w-lg aspect-square bg-gray-800 rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.5)] p-1.5 border-2 border-gray-700 mx-auto mb-20 md:mb-32">
        <div id="board" class="board-grid rounded-xl overflow-hidden relative border text-gray-800 mb-0">
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10" style="left: 40%; top: 40%; width: 20%; height: 20%;">
                <div class="rotate-45 font-black text-2xl md:text-4xl text-yellow-400 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] flex flex-col items-center justify-center h-full w-full">
                    <span class="-rotate-45 text-xl">üèÜ</span>
                </div>
            </div>
        </div>
        <div id="pieces" class="absolute top-2 left-2 right-2 bottom-2 pointer-events-none z-20"></div>
        <div id="event-toast" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl md:text-6xl font-black text-white px-8 py-3 rounded-2xl z-50 transition-all duration-300 scale-50 opacity-0 pointer-events-none" style="text-shadow: 0 4px 10px rgba(0,0,0,0.8);"></div>
    </div>

    <!-- Bottom Control Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t-2 border-gray-700 p-2 pt-4 pb-4 md:pb-8 flex flex-row items-end justify-between z-40 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.6)]">
        
        <div id="panel-0" class="flex flex-col items-center bg-gray-900 p-1.5 md:p-3 rounded-xl md:rounded-2xl border-2 md:border-4 w-20 md:w-36 transition-all duration-300">
            <div class="w-8 h-8 md:w-16 md:h-16 rounded-full bg-red-600 border border-white mb-1 shadow-[inset_0_-4px_8px_rgba(0,0,0,0.5)] relative overflow-hidden">
            </div>
            <h2 class="text-xs md:text-lg font-black text-red-100 tracking-wider uppercase">RED</h2>
        </div>

        <!-- Center Dice -->
        <div id="center-dice-container" class="flex flex-col items-center absolute left-1/2 bottom-3 md:bottom-6 transform -translate-x-1/2 z-50">
            
            <div class="dice-scene relative" id="dice-scene-wrapper">
                <div class="dice-glow-ring" id="dice-glow-ring"></div>
                <div class="dice-cube dice-show-1" id="dice-cube">
                    <!-- Face 1: center -->
                    <div class="dice-face dice-face--light dice-face-1">
                        <div style="grid-area:2/2"><div class="dice-pip" data-pip></div></div>
                    </div>
                    <!-- Face 2: diagonal -->
                    <div class="dice-face dice-face--light dice-face-2">
                        <div style="grid-area:1/3"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:3/1"><div class="dice-pip" data-pip></div></div>
                    </div>
                    <!-- Face 3: diagonal + center -->
                    <div class="dice-face dice-face--light dice-face-3">
                        <div style="grid-area:1/3"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:2/2"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:3/1"><div class="dice-pip" data-pip></div></div>
                    </div>
                    <!-- Face 4: four corners -->
                    <div class="dice-face dice-face--light dice-face-4">
                        <div style="grid-area:1/1"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:1/3"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:3/1"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:3/3"><div class="dice-pip" data-pip></div></div>
                    </div>
                    <!-- Face 5: corners + center -->
                    <div class="dice-face dice-face--light dice-face-5">
                        <div style="grid-area:1/1"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:1/3"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:2/2"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:3/1"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:3/3"><div class="dice-pip" data-pip></div></div>
                    </div>
                    <!-- Face 6: two columns -->
                    <div class="dice-face dice-face--light dice-face-6">
                        <div style="grid-area:1/1"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:2/1"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:3/1"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:1/3"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:2/3"><div class="dice-pip" data-pip></div></div>
                        <div style="grid-area:3/3"><div class="dice-pip" data-pip></div></div>
                    </div>
                </div>
            </div>
            <div class="dice-shadow" id="dice-shadow"></div>

            <button id="main-btn-roll" class="mt-1.5 px-6 py-2 md:px-12 md:py-4 bg-gray-700 hover:bg-gray-600 active:bg-gray-800 rounded-full text-white font-black text-sm md:text-2xl shadow-[0_5px_15px_rgba(0,0,0,0.5)] transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed border-2 tracking-widest relative overflow-hidden">
                ROLL
            </button>
        </div>

        <div id="panel-1" class="flex flex-col items-center bg-gray-900 p-1.5 md:p-3 rounded-xl md:rounded-2xl border-2 md:border-4 w-20 md:w-36 transition-all duration-300">
            <div class="w-8 h-8 md:w-16 md:h-16 rounded-full bg-blue-600 border border-white mb-1 shadow-[inset_0_-4px_8px_rgba(0,0,0,0.5)] relative overflow-hidden">
            </div>
            <h2 class="text-xs md:text-lg font-black text-blue-100 tracking-wider uppercase">BLUE</h2>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[70] hidden flex-col items-center justify-center">
        <h2 id="win-text" class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-8 animate-pulse tracking-tight text-center px-4" style="filter: drop-shadow(0 0 20px rgba(234,179,8,0.5));">PLAYER WINS!</h2>
        <button onclick="location.reload()" class="px-12 py-6 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 rounded-full text-white font-bold text-3xl shadow-[0_0_40px_rgba(16,185,129,0.5)] transition-all transform hover:scale-110 active:scale-95 uppercase tracking-widest border-4 border-white">Play Again</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const PATH = [
                {r:7,c:2},{r:7,c:3},{r:7,c:4},{r:7,c:5},{r:7,c:6},
                {r:6,c:7},{r:5,c:7},{r:4,c:7},{r:3,c:7},{r:2,c:7},{r:1,c:7},
                {r:1,c:8},{r:1,c:9},
                {r:2,c:9},{r:3,c:9},{r:4,c:9},{r:5,c:9},{r:6,c:9},
                {r:7,c:10},{r:7,c:11},{r:7,c:12},{r:7,c:13},{r:7,c:14},{r:7,c:15},
                {r:8,c:15},{r:9,c:15},
                {r:9,c:14},{r:9,c:13},{r:9,c:12},{r:9,c:11},{r:9,c:10},
                {r:10,c:9},{r:11,c:9},{r:12,c:9},{r:13,c:9},{r:14,c:9},{r:15,c:9},
                {r:15,c:8},{r:15,c:7},
                {r:14,c:7},{r:13,c:7},{r:12,c:7},{r:11,c:7},{r:10,c:7},
                {r:9,c:6},{r:9,c:5},{r:9,c:4},{r:9,c:3},{r:9,c:2},{r:9,c:1},
                {r:8,c:1},{r:7,c:1}
            ];
            const SAFE_SPOTS = [0,8,13,21,26,34,39,47];
            const PLAYERS = [
                { id:0,name:'RED',hex:'#f87171',border:'#991b1b',glow:'rgba(248,113,113,0.6)',pipClass:'pip-red',startIdx:0,
                  yardBases:[{r:3,c:3},{r:3,c:4},{r:4,c:3},{r:4,c:4}],
                  homePath:[{r:8,c:2},{r:8,c:3},{r:8,c:4},{r:8,c:5},{r:8,c:6}],homeCenter:{r:8,c:7.5}},
                { id:1,name:'BLUE',hex:'#60a5fa',border:'#1d4ed8',glow:'rgba(96,165,250,0.6)',pipClass:'pip-blue',startIdx:26,
                  yardBases:[{r:12,c:12},{r:12,c:13},{r:13,c:12},{r:13,c:13}],
                  homePath:[{r:8,c:14},{r:8,c:13},{r:8,c:12},{r:8,c:11},{r:8,c:10}],homeCenter:{r:8,c:8.5}}
            ];

            let state = {
                turn:0, phase:'ROLL', diceValue:null,
                pieces:[
                    {player:0,id:0,pos:-1},{player:0,id:1,pos:-1},{player:0,id:2,pos:-1},{player:0,id:3,pos:-1},
                    {player:1,id:0,pos:-1},{player:1,id:1,pos:-1},{player:1,id:2,pos:-1},{player:1,id:3,pos:-1}
                ]
            };

            const UI = {
                board: document.getElementById('board'),
                pieces: document.getElementById('pieces'),
                status: document.getElementById('game-status'),
                winModal: document.getElementById('win-modal'),
                winText: document.getElementById('win-text'),
                mainBtn: document.getElementById('main-btn-roll'),
                diceCube: document.getElementById('dice-cube'),
                diceGlowRing: document.getElementById('dice-glow-ring'),
                diceShadow: document.getElementById('dice-shadow'),
                panels: [document.getElementById('panel-0'), document.getElementById('panel-1')],
                toast: document.getElementById('event-toast')
            };

            const sleep = ms => new Promise(res => setTimeout(res, ms));

            const DICE_SHOW = {
                1:'dice-show-1',2:'dice-show-2',3:'dice-show-3',
                4:'dice-show-4',5:'dice-show-5',6:'dice-show-6'
            };
            const DICE_TRANSFORMS = {
                1:'rotateY(0deg) rotateX(0deg)',
                2:'rotateY(-90deg) rotateX(0deg)',
                3:'rotateX(-90deg) rotateY(0deg)',
                4:'rotateX(90deg) rotateY(0deg)',
                5:'rotateY(90deg) rotateX(0deg)',
                6:'rotateY(180deg) rotateX(0deg)'
            };

            function showDiceFace(val) {
                for(let i=1;i<=6;i++) UI.diceCube.classList.remove(DICE_SHOW[i]);
                UI.diceCube.classList.add(DICE_SHOW[val]);
            }

            // Color the pips of the result face to match the player
            function colorResultPips(val, playerIdx) {
                const allPips = UI.diceCube.querySelectorAll('[data-pip]');
                allPips.forEach(p => { p.classList.remove('pip-red','pip-blue'); });
                
                const faceEl = UI.diceCube.querySelector(`.dice-face-${val}`);
                if(faceEl) {
                    const pips = faceEl.querySelectorAll('[data-pip]');
                    pips.forEach(p => p.classList.add(PLAYERS[playerIdx].pipClass));
                }
            }

            function resetPipColors() {
                const allPips = UI.diceCube.querySelectorAll('[data-pip]');
                allPips.forEach(p => { p.classList.remove('pip-red','pip-blue'); });
            }

            function initBoard() {
                while(UI.board.firstChild) UI.board.removeChild(UI.board.firstChild);
                
                for(let r=1;r<=15;r++){
                    for(let c=1;c<=15;c++){
                        let isRedHome=r===8&&c>=2&&c<=6, isBlueHome=r===8&&c>=10&&c<=14;
                        let isYellowHome=c===8&&r>=2&&r<=6, isGreenHome=c===8&&r>=10&&r<=14;
                        let isCenter=r>=7&&r<=9&&c>=7&&c<=9;
                        let bgColor='#ffffff';
                        if(r<=6&&c<=6) bgColor='#991b1b';
                        if(r<=6&&c>=10) bgColor='#fef08a';
                        if(r>=10&&c<=6) bgColor='#bbf7d0';
                        if(r>=10&&c>=10) bgColor='#1e40af';
                        if(isRedHome) bgColor='#991b1b';
                        if(isBlueHome) bgColor='#1e40af';
                        if(isYellowHome) bgColor='#fde047';
                        if(isGreenHome) bgColor='#86efac';
                        if(isCenter) bgColor='#1e293b';

                        let safeIdx=PATH.findIndex(p=>p.r===r&&p.c===c);
                        let isSafe=safeIdx>-1&&SAFE_SPOTS.includes(safeIdx);
                        if(isSafe){
                            if(safeIdx===0) bgColor='#dc2626';
                            else if(safeIdx===26) bgColor='#0ea5e9';
                            else if(safeIdx===13) bgColor='#ca8a04';
                            else if(safeIdx===39) bgColor='#16a34a';
                            else bgColor='#334155';
                        }
                        let cell=document.createElement('div');
                        cell.className='cell relative flex items-center justify-center';
                        cell.style.backgroundColor=bgColor;
                        // Hide grid in all home yard areas (red, blue, yellow, green)
                        if((r<=6&&c<=6) || (r>=10&&c>=10) || (r<=6&&c>=10) || (r>=10&&c<=6)) {
                            cell.style.border=`0.5px solid ${bgColor}`;
                        }
                        if(isSafe&&!isCenter) cell.innerHTML=`<span class="text-white text-base md:text-xl drop-shadow-md">‚òÖ</span>`;
                        else if(isCenter) cell.style.border='none';
                        UI.board.appendChild(cell);
                    }
                }
                const ov=document.createElement('div');
                ov.className='absolute inset-0 flex items-center justify-center pointer-events-none z-10';
                ov.style.cssText='left:40%;top:40%;width:20%;height:20%';
                ov.innerHTML=`<div class="rotate-45 font-black text-2xl md:text-4xl text-yellow-400 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] flex flex-col items-center justify-center h-full w-full"><span class="-rotate-45 text-xl">üèÜ</span></div>`;
                UI.board.appendChild(ov);

                function drawYardInner(r,c){
                    let y=document.createElement('div');
                    y.className='absolute bg-white/90 backdrop-blur-sm rounded-xl md:rounded-2xl shadow-[inset_0_2px_10px_rgba(0,0,0,0.1)] border border-slate-300';
                    y.style.left=`calc(${c-1}*100%/15 + 3%)`;y.style.top=`calc(${r-1}*100%/15 + 3%)`;
                    y.style.width=`calc(4*100%/15 - 6%)`;y.style.height=`calc(4*100%/15 - 6%)`;
                    UI.pieces.appendChild(y);
                }
                drawYardInner(2,2);drawYardInner(11,11);drawYardInner(2,11);drawYardInner(11,2);

                state.pieces.forEach(p=>{
                    let el=document.createElement('div');
                    el.id=`piece-${p.player}-${p.id}`;
                    el.className='piece absolute rounded-full flex items-center justify-center pointer-events-auto border-[3px]';
                    let pct=100/15;
                    el.style.width=`calc(${pct}% - 4px)`;el.style.height=`calc(${pct}% - 4px)`;
                    el.style.backgroundColor=PLAYERS[p.player].hex;
                    el.style.borderColor=PLAYERS[p.player].border;
                    el.innerHTML=`<div class="w-1/2 h-1/2 rounded-full bg-white/40 shadow-[inset_0_2px_4px_rgba(0,0,0,0.2)]"></div>`;
                    el.onclick=()=>onPieceClick(p.player,p.id);
                    UI.pieces.appendChild(el);
                });

                UI.mainBtn.onclick=handleRoll;
                updateGeneralUI();
                renderPieces();
            }

            function renderPieces(){
                let occ={};
                state.pieces.forEach(p=>{
                    let coord;
                    if(p.pos===-1) coord=PLAYERS[p.player].yardBases[p.id];
                    else if(p.pos>=0&&p.pos<=50) coord=PATH[(PLAYERS[p.player].startIdx+p.pos)%52];
                    else if(p.pos>=51&&p.pos<=55) coord=PLAYERS[p.player].homePath[p.pos-51];
                    else if(p.pos===56) coord=PLAYERS[p.player].homeCenter;
                    p.coord=coord;
                    let k=`${coord.r},${coord.c}`;
                    if(!occ[k]) occ[k]=[];
                    occ[k].push(p);
                });
                state.pieces.forEach(p=>{
                    let el=document.getElementById(`piece-${p.player}-${p.id}`);
                    let o=occ[`${p.coord.r},${p.coord.c}`];
                    let idx=o.indexOf(p);
                    let bL=(p.coord.c-1)*(100/15), bT=(p.coord.r-1)*(100/15);
                    let tx=0,ty=0;
                    if(o.length>1&&p.pos!==-1&&p.pos!==56){
                        const offs=[{x:-15,y:-15},{x:15,y:-15},{x:-15,y:15},{x:15,y:15}];
                        if(idx<4){tx=offs[idx].x;ty=offs[idx].y;}
                    }
                    el.style.left=`calc(${bL}% + 2px)`;
                    el.style.top=`calc(${bT}% + 2px)`;
                    el.style.transform=`translate(${tx}%,${ty}%)`;
                    if(state.phase==='MOVE'&&state.turn===p.player&&isValidMove(p)) el.classList.add('highlight');
                    else el.classList.remove('highlight');
                });
            }

            function updateGeneralUI(){
                UI.mainBtn.disabled=(state.phase!=='ROLL');
                let p=state.turn;

                UI.diceGlowRing.style.boxShadow=`0 0 18px ${PLAYERS[p].glow}, 0 0 36px ${PLAYERS[p].glow}`;
                if(state.phase==='ROLL') UI.diceGlowRing.classList.add('active');
                else UI.diceGlowRing.classList.remove('active');

                UI.mainBtn.style.borderColor=PLAYERS[p].border;
                UI.mainBtn.style.backgroundColor=state.phase==='ROLL'?PLAYERS[p].hex:'#374151';

                UI.panels.forEach((panel,i)=>{
                    if(i===state.turn){
                        panel.style.transform='translateY(-10px) scale(1.05)';
                        panel.style.opacity='1';
                        panel.style.borderColor=PLAYERS[i].hex;
                        panel.style.boxShadow=`0 10px 30px ${PLAYERS[i].glow}`;
                        panel.classList.add('active-panel');
                    } else {
                        panel.style.transform='translateY(10px) scale(0.95)';
                        panel.style.opacity='0.5';
                        panel.style.borderColor='rgba(107,114,128,0.5)';
                        panel.style.boxShadow='none';
                        panel.classList.remove('active-panel');
                    }
                });

                if(state.phase==='ROLL'){
                    UI.status.innerText=`${PLAYERS[state.turn].name}'S TURN TO ROLL`;
                    UI.status.style.color='#fef08a';
                } else if(state.phase==='MOVE'){
                    UI.status.innerText=`SELECT A PIECE TO MOVE (${state.diceValue})`;
                    UI.status.style.color='#ffffff';
                } else if(state.phase==='ANIMATING'){
                    UI.status.innerText='MOVING...';
                    UI.status.style.color='#9ca3af';
                }
            }

            function handleRoll(){
                if(state.phase!=='ROLL') return;
                state.phase='ANIMATING';
                updateGeneralUI();
                resetPipColors();

                // Remove previous show/landed classes
                UI.diceCube.classList.remove('landed');
                for(let i=1;i<=6;i++) UI.diceCube.classList.remove(DICE_SHOW[i]);

                // Start tumble
                UI.diceCube.classList.add('rolling');
                UI.diceShadow.classList.add('rolling');

                let val=Math.floor(Math.random()*6)+1;
                state.diceValue=val;

                setTimeout(()=>{
                    UI.diceCube.classList.remove('rolling');
                    UI.diceShadow.classList.remove('rolling');

                    // Land on the result face
                    UI.diceCube.style.setProperty('--land-transform', DICE_TRANSFORMS[val]);
                    showDiceFace(val);
                    UI.diceCube.classList.add('landed');

                    // Color pips to match current player
                    colorResultPips(val, state.turn);

                    setTimeout(()=>{ UI.diceCube.classList.remove('landed'); }, 300);
                    evaluateRoll();
                }, 680);
            }

            function evaluateRoll(){
                let valid=state.pieces.filter(p=>p.player===state.turn&&isValidMove(p));
                if(valid.length===0){
                    UI.status.innerText="NO VALID MOVES!";
                    UI.status.style.color='#fff';
                    setTimeout(()=>switchTurn(false),1200);
                } else {
                    state.phase='MOVE';
                    updateGeneralUI();
                    renderPieces();
                }
            }

            function isValidMove(piece){
                if(piece.pos===-1) return state.diceValue===6;
                if(piece.pos+state.diceValue>56) return false;
                return true;
            }

            async function animatePieceForward(piece,startPos,endPos){
                if(startPos===-1&&endPos>=0){piece.pos=0;renderPieces();await sleep(250);startPos=0;}
                let cur=startPos;
                while(cur<endPos){cur++;piece.pos=cur;renderPieces();if(cur!==endPos) await sleep(220);}
                await sleep(200);
            }

            async function animatePieceBackward(piece,startPos){
                let cur=startPos;
                while(cur>0){cur--;piece.pos=cur;renderPieces();await sleep(35);}
                piece.pos=-1;renderPieces();await sleep(100);
            }

            function showCelebrationToast(text,colorHex,shadowHex){
                UI.toast.innerText=text;
                UI.toast.className='absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl md:text-5xl font-black text-white px-8 py-3 rounded-2xl z-50 transition-all duration-300 pointer-events-none scale-110 opacity-100';
                UI.toast.style.backgroundColor=colorHex;
                UI.toast.style.boxShadow=`0 10px 40px ${shadowHex}, inset 0 2px 4px rgba(255,255,255,0.4)`;
                setTimeout(()=>{UI.toast.style.opacity='0';UI.toast.style.transform='translate(-50%,-50%) scale(0.5)';},1500);
            }

            async function onPieceClick(player,id){
                if(state.phase!=='MOVE'||state.turn!==player) return;
                let piece=state.pieces.find(p=>p.player===player&&p.id===id);
                if(!isValidMove(piece)) return;
                state.phase='ANIMATING';updateGeneralUI();renderPieces();
                let startPos=piece.pos, targetPos=piece.pos===-1?0:piece.pos+state.diceValue;
                await animatePieceForward(piece,startPos,targetPos);
                let isYardOut=(startPos===-1), bonus=state.diceValue===6;
                if(piece.pos===56){
                    bonus=true;
                    showCelebrationToast("HOME!",PLAYERS[player].hex,PLAYERS[player].glow);
                    if(window.confetti) confetti({particleCount:50,spread:80,origin:{y:0.5},colors:[PLAYERS[player].hex,'#ffffff'],zIndex:100});
                    await sleep(1200);
                }
                let cutOccurred=false;
                if(!isYardOut&&piece.pos>=0&&piece.pos<=50){
                    let absPos=(PLAYERS[player].startIdx+piece.pos)%52;
                    let opp=1-player;
                    if(!SAFE_SPOTS.includes(absPos)){
                        for(let o of state.pieces){
                            if(o.player===opp&&o.pos>=0&&o.pos<=50){
                                let oppAbs=(PLAYERS[opp].startIdx+o.pos)%52;
                                if(oppAbs===absPos){
                                    cutOccurred=true;
                                    showCelebrationToast("CUT!",PLAYERS[player].hex,PLAYERS[player].glow);
                                    await animatePieceBackward(o,o.pos);
                                }
                            }
                        }
                    }
                }
                if(cutOccurred) bonus=true;
                if(state.pieces.filter(p=>p.player===player&&p.pos===56).length===4){
                    state.phase='WIN';
                    if(window.confetti){let end=Date.now()+4000;(function f(){confetti({particleCount:5,angle:60,spread:55,origin:{x:0},zIndex:100});confetti({particleCount:5,angle:120,spread:55,origin:{x:1},zIndex:100});if(Date.now()<end)requestAnimationFrame(f);}());}
                    UI.winModal.classList.remove('hidden');UI.winModal.classList.add('flex');
                    UI.winText.innerText=`${PLAYERS[player].name} WINS!`;return;
                }
                if(bonus){UI.status.innerText="BONUS TURN!";UI.status.style.color='#4ade80';await sleep(1000);switchTurn(true);}
                else switchTurn(false);
            }

            function switchTurn(keepTurn){
                if(!keepTurn) state.turn=1-state.turn;
                state.phase='ROLL';
                resetPipColors();
                updateGeneralUI();
                renderPieces();
            }

            initBoard();
        });
    </script>
</body>
</html>