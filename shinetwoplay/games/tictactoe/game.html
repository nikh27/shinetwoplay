<!-- TicTacToe Game UI - Panda Edition (Multiplayer) -->

<div class="ttt-container">
    <!-- Header: Exit + Round -->
    <div class="ttt-top-bar">
        <button class="ttt-exit-btn" onclick="exitGame()">‚úï</button>
        <div class="ttt-round-badge" id="ttt-round-info">Round 1/1</div>
    </div>

    <!-- Header Removed (Merged into bubbles) -->

    <!-- Panda area: avatar bubble left + panda center + avatar bubble right -->
    <div class="ttt-panda-row">
        <!-- X player avatar bubble -->
        <div class="ttt-avatar-bubble ttt-bubble-x" id="ttt-bubble-x">
            <div class="ttt-bubble-name" id="ttt-name-x">Player 1</div>
            <div class="ttt-bubble-img" id="ttt-bubble-img-x"></div>
            <div class="ttt-bubble-mark">‚úï</div>
            <div class="ttt-bubble-score">Score: <span id="ttt-score-x">0</span></div>
        </div>

        <!-- Panda + speech + turn indicator -->
        <div class="ttt-panda-center">
            <div class="ttt-speech-bubble" id="ttt-speech-bubble">Let's go! üêº</div>
            <div class="ttt-panda-container" id="ttt-panda-container">
                <div class="ttt-panda thinking" id="ttt-panda">
                    <div class="ttt-panda-body">
                        <div class="ttt-panda-belly"></div>
                    </div>
                    <div class="ttt-panda-arm left"></div>
                    <div class="ttt-panda-arm right"></div>
                    <div class="ttt-panda-head">
                        <div class="ttt-panda-ear left"></div>
                        <div class="ttt-panda-ear right"></div>
                        <div class="ttt-panda-eye-patch left"></div>
                        <div class="ttt-panda-eye-patch right"></div>
                        <div class="ttt-panda-eye left">
                            <div class="ttt-panda-pupil" id="ttt-pupil-left"></div>
                        </div>
                        <div class="ttt-panda-eye right">
                            <div class="ttt-panda-pupil" id="ttt-pupil-right"></div>
                        </div>
                        <div class="ttt-panda-blush left"></div>
                        <div class="ttt-panda-blush right"></div>
                        <div class="ttt-panda-nose"></div>
                        <div class="ttt-panda-mouth"></div>
                    </div>
                </div>
            </div>
            <div class="ttt-turn-indicator" id="ttt-turn-indicator">
                <span id="ttt-turn-text">Your turn!</span>
            </div>
        </div>

        <!-- O player avatar bubble -->
        <div class="ttt-avatar-bubble ttt-bubble-o" id="ttt-bubble-o">
            <div class="ttt-bubble-name" id="ttt-name-o">Player 2</div>
            <div class="ttt-bubble-img" id="ttt-bubble-img-o"></div>
            <div class="ttt-bubble-mark">‚óã</div>
            <div class="ttt-bubble-score">Score: <span id="ttt-score-o">0</span></div>
        </div>
    </div>

    <!-- Game Board -->
    <div class="ttt-board-container">
        <div class="ttt-board" id="ttt-board">
            <!-- Cells generated by JS -->
        </div>
    </div>

    <!-- Pause overlay -->
    <div class="ttt-pause-overlay" id="ttt-pause-overlay" style="display:none;">
        <div class="ttt-pause-content">
            <div style="font-size:48px;">‚è∏Ô∏è</div>
            <h2>Game Paused</h2>
            <p><span id="ttt-disconnected-player">Player</span> disconnected</p>
            <p>Waiting... <span id="ttt-countdown">30</span>s</p>
        </div>
    </div>

    <!-- Result overlay -->
    <div class="ttt-result-overlay" id="ttt-result-overlay" style="display:none;">
        <div class="ttt-result-content">
            <div id="ttt-result-icon" style="font-size:48px;">üèÜ</div>
            <h2 id="ttt-result-text">You Win!</h2>
            <p id="ttt-result-subtext">Next round starting...</p>
        </div>
    </div>
</div>

<style>
/* ===== TicTacToe Panda - All scoped to .ttt- ===== */
.ttt-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    height: 100%;
    padding: 8px 12px;
    position: relative;
    overflow: hidden;
    transition: background 0.5s ease;
    font-family: 'Fredoka', sans-serif;
}

/* Dynamic background based on turn */
.ttt-container.bg-x { background: linear-gradient(135deg, #ff6b6b 0%, #c0392b 50%, #8e2424 100%); }
.ttt-container.bg-o { background: linear-gradient(135deg, #4fc3f7 0%, #2980b9 50%, #1a5276 100%); }

/* Top bar */
.ttt-top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    margin-bottom: 6px;
    flex-shrink: 0;
}

.ttt-exit-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.2);
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    transition: all 0.2s;
}
.ttt-exit-btn:hover { background: rgba(255,255,255,0.35); }

.ttt-round-badge {
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

/* Header styles removed */

/* ===== Panda Row: avatar_x + panda + avatar_o ===== */
.ttt-panda-row {
    display: flex;
    align-items: flex-end;
    justify-content: center;
    gap: 12px;
    width: 100%;
    margin-bottom: 4px;
    flex-shrink: 0;
}

/* Avatar bubbles beside panda */
.ttt-avatar-bubble {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    opacity: 0.7;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform: scale(0.9);
    background: rgba(255,255,255,0.15);
    padding: 6px 10px;
    border-radius: 12px;
    backdrop-filter: blur(4px);
    width: 80px;
}
.ttt-avatar-bubble.active {
    opacity: 1;
    transform: scale(1);
    background: rgba(255,255,255,0.3);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.ttt-bubble-name {
    font-size: 10px;
    font-weight: 700;
    color: white;
    max-width: 76px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-align: center;
}

.ttt-bubble-img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.2);
}
.ttt-bubble-img img { width: 100%; height: 100%; object-fit: cover; }

.ttt-bubble-x .ttt-bubble-img { border-color: #ff6b6b; }
.ttt-bubble-o .ttt-bubble-img { border-color: #4fc3f7; }

.ttt-bubble-mark {
    font-size: 12px;
    font-weight: 800;
    line-height: 1;
    margin-top: -2px;
}
.ttt-bubble-x .ttt-bubble-mark { color: #ff6b6b; }
.ttt-bubble-o .ttt-bubble-mark { color: #4fc3f7; }

.ttt-bubble-score {
    font-size: 9px;
    font-weight: 600;
    color: rgba(255,255,255,0.9);
}

/* Panda center column */
.ttt-panda-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

/* Turn indicator */
.ttt-turn-indicator {
    padding: 3px 14px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    transition: all 0.3s;
    background: rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.7);
    margin-top: 2px;
}
.ttt-turn-indicator.my-turn {
    background: rgba(255,255,255,0.9);
    color: #333;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

/* ===== Panda Character ===== */
.ttt-panda-container {
    position: relative;
    width: 70px;
    height: 78px;
    cursor: pointer;
    z-index: 10;
    flex-shrink: 0;
}

.ttt-panda {
    position: relative;
    width: 100%;
    height: 100%;
    animation: ttt-panda-bounce 2s ease-in-out infinite;
    transition: transform 0.2s;
}
.ttt-panda-container:active .ttt-panda { transform: scale(0.9); }

@keyframes ttt-panda-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
}

.ttt-panda-body {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 46px;
    height: 38px;
    background: linear-gradient(180deg, #f5f5f0 0%, #e8e8e0 100%);
    border-radius: 23px 23px 20px 20px;
    box-shadow: inset -5px 0 10px rgba(0,0,0,0.1), 0 5px 14px rgba(0,0,0,0.3);
}

.ttt-panda-belly {
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    width: 24px;
    height: 18px;
    background: linear-gradient(180deg, #fafafa 0%, #f0f0e8 100%);
    border-radius: 50%;
}

.ttt-panda-head {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 56px;
    height: 48px;
    background: linear-gradient(180deg, #fff 0%, #f5f5f0 50%, #e8e8e0 100%);
    border-radius: 28px 28px 24px 24px;
    box-shadow: inset -5px 0 12px rgba(0,0,0,0.08), 0 3px 10px rgba(0,0,0,0.2);
}

.ttt-panda-ear {
    position: absolute;
    width: 18px;
    height: 18px;
    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
    border-radius: 50%;
}
.ttt-panda-ear.left { top: -2px; left: 4px; transform: rotate(-15deg); }
.ttt-panda-ear.right { top: -2px; right: 4px; transform: rotate(15deg); }

.ttt-panda-eye-patch {
    position: absolute;
    width: 18px;
    height: 20px;
    background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
    border-radius: 50% 50% 45% 45%;
    top: 12px;
}
.ttt-panda-eye-patch.left { left: 7px; transform: rotate(-10deg); }
.ttt-panda-eye-patch.right { right: 7px; transform: rotate(10deg); }

.ttt-panda-eye {
    position: absolute;
    width: 9px;
    height: 9px;
    background: white;
    border-radius: 50%;
    top: 17px;
}
.ttt-panda-eye.left { left: 12px; }
.ttt-panda-eye.right { right: 12px; }

.ttt-panda-pupil {
    position: absolute;
    width: 5px;
    height: 5px;
    background: #1a1a1a;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: all 0.15s ease;
}
.ttt-panda-pupil::after {
    content: '';
    position: absolute;
    width: 2px;
    height: 2px;
    background: white;
    border-radius: 50%;
    top: 1px;
    left: 1px;
}

.ttt-panda-nose {
    position: absolute;
    top: 28px;
    left: 50%;
    transform: translateX(-50%);
    width: 10px;
    height: 6px;
    background: #1a1a1a;
    border-radius: 50% 50% 50% 50% / 30% 30% 70% 70%;
}

.ttt-panda-mouth {
    position: absolute;
    top: 33px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 5px;
    border-bottom: 2px solid #1a1a1a;
    border-radius: 0 0 50% 50%;
    transition: all 0.2s ease;
}

.ttt-panda-blush {
    position: absolute;
    width: 10px;
    height: 5px;
    background: rgba(255, 150, 170, 0.6);
    border-radius: 50%;
    top: 28px;
    filter: blur(2px);
    opacity: 0;
    transition: opacity 0.3s;
}
.ttt-panda-blush.left { left: 2px; }
.ttt-panda-blush.right { right: 2px; }

.ttt-panda-arm {
    position: absolute;
    width: 16px;
    height: 26px;
    background: linear-gradient(90deg, #2a2a2a 0%, #1a1a1a 100%);
    border-radius: 8px;
    bottom: 10px;
}
.ttt-panda-arm.left {
    left: 2px;
    transform: rotate(20deg);
    transform-origin: top center;
    animation: ttt-wave-left 2s ease-in-out infinite;
}
.ttt-panda-arm.right {
    right: 2px;
    transform: rotate(-20deg);
    transform-origin: top center;
    animation: ttt-wave-right 2s ease-in-out infinite 0.5s;
}

@keyframes ttt-wave-left {
    0%, 100% { transform: rotate(20deg); }
    50% { transform: rotate(30deg); }
}
@keyframes ttt-wave-right {
    0%, 100% { transform: rotate(-20deg); }
    50% { transform: rotate(-30deg); }
}

/* Panda states */
.ttt-panda.ttt-poked { animation: ttt-panda-poked 0.5s ease-in-out !important; }
.ttt-panda.ttt-poked .ttt-panda-blush { opacity: 1; }
.ttt-panda.ttt-poked .ttt-panda-mouth {
    width: 10px; height: 8px; border: none; background: #1a1a1a; border-radius: 50%;
}

@keyframes ttt-panda-poked {
    0% { transform: scale(1) rotate(0); }
    25% { transform: scale(0.85) rotate(-10deg); }
    50% { transform: scale(1.1) rotate(5deg); }
    75% { transform: scale(0.95) rotate(-3deg); }
    100% { transform: scale(1) rotate(0); }
}

.ttt-panda.ttt-excited { animation: ttt-panda-jump 0.4s ease-in-out infinite !important; }
.ttt-panda.ttt-excited .ttt-panda-arm.left,
.ttt-panda.ttt-excited .ttt-panda-arm.right { animation: ttt-excited-wave 0.2s ease-in-out infinite !important; }
.ttt-panda.ttt-excited .ttt-panda-mouth { width: 12px; height: 8px; border: none; background: #1a1a1a; border-radius: 50%; }
.ttt-panda.ttt-excited .ttt-panda-blush { opacity: 1; }

@keyframes ttt-excited-wave { 0%, 100% { transform: rotate(40deg); } 50% { transform: rotate(-40deg); } }
@keyframes ttt-panda-jump { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-12px) scale(1.1); } }

.ttt-panda.ttt-sad .ttt-panda-mouth { border-bottom: none; border-top: 2px solid #1a1a1a; border-radius: 50% 50% 0 0; top: 35px; }
.ttt-panda.ttt-sad { animation: ttt-sad-sway 1.5s ease-in-out infinite !important; }
@keyframes ttt-sad-sway { 0%, 100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(3px) rotate(3deg); } }

.ttt-panda.thinking .ttt-panda-pupil { animation: ttt-look-around 2s ease-in-out infinite; }
@keyframes ttt-look-around {
    0%, 100% { transform: translate(0, 0); }
    25% { transform: translate(-2px, -1px); }
    50% { transform: translate(2px, 0); }
    75% { transform: translate(0, 2px); }
}

/* Speech bubble */
.ttt-speech-bubble {
    background: white;
    padding: 4px 10px;
    border-radius: 12px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
    z-index: 20;
    transform: scale(0);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    margin-bottom: 2px;
}
.ttt-speech-bubble::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 6px solid white;
}
.ttt-speech-bubble.show { transform: scale(1); }

/* ===== Game Board ===== */
.ttt-board-container {
    perspective: 600px;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    min-height: 0;
}

.ttt-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: clamp(6px, 2vw, 10px);
    padding: clamp(10px, 2.5vw, 16px);
    background: rgba(255,255,255,0.15);
    border-radius: 20px;
    box-shadow: 0 16px 32px rgba(0,0,0,0.4), inset 0 2px 8px rgba(255,255,255,0.2);
    transform: rotateX(5deg);
    transition: transform 0.3s;
    backdrop-filter: blur(10px);
}

.ttt-board.shake { animation: ttt-board-shake 0.4s ease-in-out; }
@keyframes ttt-board-shake {
    0%, 100% { transform: rotateX(5deg) rotateY(0); }
    25% { transform: rotateX(5deg) rotateY(-8deg); }
    75% { transform: rotateX(5deg) rotateY(8deg); }
}

.ttt-cell {
    width: clamp(75px, 24vw, 95px);
    height: clamp(75px, 24vw, 95px);
    background: rgba(255,255,255,0.9);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 3px 3px 10px rgba(0,0,0,0.25), inset 0 2px 4px rgba(255,255,255,0.8);
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    user-select: none;
}
.ttt-cell::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 50%;
    background: linear-gradient(180deg, rgba(255,255,255,0.5) 0%, transparent 100%);
    border-radius: 16px 16px 0 0;
    pointer-events: none;
}
.ttt-cell:active:not(.taken) { transform: scale(0.92); }
.ttt-cell.taken { cursor: default; }
.ttt-cell.winning {
    animation: ttt-winner-glow 0.6s ease-in-out infinite alternate;
    background: linear-gradient(145deg, #fff9e6, #ffd700);
}
@keyframes ttt-winner-glow {
    0% { box-shadow: 3px 3px 10px rgba(0,0,0,0.25), 0 0 12px rgba(255,215,0,0.6); transform: scale(1); }
    100% { box-shadow: 3px 3px 10px rgba(0,0,0,0.25), 0 0 24px rgba(255,215,0,0.9); transform: scale(1.04); }
}

/* Marks */
.ttt-mark {
    font-size: clamp(32px, 10vw, 48px);
    font-weight: 700;
    animation: ttt-pop-in 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.ttt-mark-x { color: #e74c3c; text-shadow: 2px 2px 0 #c0392b, 2px 2px 6px rgba(231,76,60,0.4); }
.ttt-mark-o { color: #3498db; text-shadow: 2px 2px 0 #2980b9, 2px 2px 6px rgba(52,152,219,0.4); }

@keyframes ttt-pop-in {
    0% { transform: scale(0) rotate(-180deg); opacity: 0; }
    60% { transform: scale(1.25) rotate(10deg); }
    100% { transform: scale(1) rotate(0); opacity: 1; }
}

/* ===== Overlays ===== */
.ttt-pause-overlay,
.ttt-result-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    z-index: 50;
}

.ttt-pause-content,
.ttt-result-content {
    text-align: center;
    color: white;
    animation: ttt-pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.ttt-result-content h2 { font-size: 28px; margin: 10px 0; }
.ttt-result-content p { color: #aaa; font-size: 14px; }
.ttt-pause-content h2 { font-size: 24px; margin: 10px 0; }
.ttt-pause-content p { color: #aaa; font-size: 13px; }

/* ===== Particles & Confetti ===== */
.ttt-particle {
    position: fixed;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    pointer-events: none;
    animation: ttt-float-particle 2.5s ease-out forwards;
    z-index: 1;
}
@keyframes ttt-float-particle {
    0% { transform: translateY(0) scale(1); opacity: 0.8; }
    100% { transform: translateY(-80vh) scale(0); opacity: 0; }
}

.ttt-confetti {
    position: fixed;
    width: 8px;
    height: 8px;
    top: -20px;
    z-index: 101;
    animation: ttt-confetti-fall linear forwards;
}
@keyframes ttt-confetti-fall {
    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

.ttt-heart {
    position: absolute;
    font-size: 14px;
    animation: ttt-float-heart 1s ease-out forwards;
    pointer-events: none;
    z-index: 15;
}
@keyframes ttt-float-heart {
    0% { transform: translateY(0) scale(0); opacity: 1; }
    50% { transform: translateY(-25px) scale(1.2); opacity: 1; }
    100% { transform: translateY(-50px) scale(0.8); opacity: 0; }
}
</style>

<script>
// ===== TicTacToe Panda - Multiplayer Game Class =====

// Panda phrases
const tttPhrases = {
    tap: ["Hehe! üòä", "That tickles!", "Hello! üëã", "More!", "Haha! ü§≠"],
    move: ["Nice! üëç", "Ooh! üòÆ", "Good one!", "Hmm... ü§î", "Cool!"],
    notYourTurn: ["Not your turn! üôÖ", "Wait! ‚úã", "Hold on! ‚è≥", "Patience! üò§", "Their turn! üîÑ"],
    winSelf: ["You win! üéâ", "Amazing! üíñ", "Woohoo! ü•≥"],
    winOther: ["Nice try! üòÖ", "Next time!", "So close!"],
    draw: ["It's a tie! ü§ù", "So close! üòÖ", "Again!"],
    start: ["Let's go! üéÆ", "Ready! üêº", "Game on! ‚ú®"]
};

class TicTacToeGame extends BaseGame {
    constructor() {
        super();
        this.gameMode = "turn_based";
        this.pandaTapCount = 0;
        this.lastTapTime = 0;
        this._wrongTurnCooldown = false;
    }

    init(state) {
        this.state = state;
        this.setupPanda();
        this.renderBoard();
        this.updatePlayers();
        this.updateScores();
        this.updateTurnIndicator();
        this.updateBackground();
        this.updateAvatarBubbles();
        this.tttShowSpeech('start');
    }

    update(state) {
        const prevMark = this.state ? this.state.current_mark : null;
        this.state = state;
        this.renderBoard();
        this.updatePlayers();
        this.updateScores();
        this.updateTurnIndicator();
        this.updateBackground();
        this.updateAvatarBubbles();

        // Panda reacts to moves
        if (prevMark && prevMark !== state.current_mark) {
            if (Math.random() < 0.5) this.tttShowSpeech('move');
        }

        if (state.paused) {
            this.showPauseOverlay();
        } else {
            this.hidePauseOverlay();
        }
    }

    setupPanda() {
        const container = document.getElementById('ttt-panda-container');
        if (!container) return;

        container.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.handlePandaTap(e);
        });

        // Eye tracking
        document.addEventListener('mousemove', (e) => this.moveEyes(e.clientX, e.clientY));
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 0) this.moveEyes(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: true });
    }

    moveEyes(x, y) {
        const container = document.getElementById('ttt-panda-container');
        if (!container) return;
        const rect = container.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 3;
        const angle = Math.atan2(y - cy, x - cx);
        const dist = Math.min(2.5, Math.hypot(x - cx, y - cy) / 60);
        const ex = Math.cos(angle) * dist;
        const ey = Math.sin(angle) * dist;
        const pl = document.getElementById('ttt-pupil-left');
        const pr = document.getElementById('ttt-pupil-right');
        if (pl) pl.style.transform = `translate(${ex}px, ${ey}px)`;
        if (pr) pr.style.transform = `translate(${ex}px, ${ey}px)`;
    }

    handlePandaTap(e) {
        const now = Date.now();
        const diff = now - this.lastTapTime;
        this.lastTapTime = now;

        // Create hearts
        const container = document.getElementById('ttt-panda-container');
        const rect = container.getBoundingClientRect();
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const heart = document.createElement('div');
                heart.className = 'ttt-heart';
                heart.textContent = ['‚ù§Ô∏è','üíï','üíñ','ü©∑','üíó'][Math.floor(Math.random() * 5)];
                heart.style.left = (rect.left + Math.random() * rect.width) + 'px';
                heart.style.top = (rect.top + Math.random() * 20) + 'px';
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 1000);
            }, i * 100);
        }

        if (diff < 300) {
            this.pandaTapCount++;
            if (this.pandaTapCount > 5) {
                this.setPandaState('ttt-dizzy');
                setTimeout(() => this.setPandaState('thinking'), 2000);
            } else {
                this.setPandaState('ttt-poked');
                this.tttShowSpeech('tap');
                setTimeout(() => this.setPandaState('thinking'), 500);
            }
        } else {
            this.pandaTapCount = 1;
            this.setPandaState('ttt-poked');
            this.tttShowSpeech('tap');
            setTimeout(() => this.setPandaState('thinking'), 500);
        }
    }

    setPandaState(state) {
        const panda = document.getElementById('ttt-panda');
        if (panda) panda.className = 'ttt-panda ' + state;
    }

    tttShowSpeech(category) {
        const bubble = document.getElementById('ttt-speech-bubble');
        if (!bubble) return;
        const list = tttPhrases[category];
        if (!list) return;
        bubble.textContent = list[Math.floor(Math.random() * list.length)];
        bubble.classList.add('show');
        clearTimeout(this._speechTimeout);
        this._speechTimeout = setTimeout(() => bubble.classList.remove('show'), 1500);
    }

    updateBackground() {
        const container = document.querySelector('.ttt-container');
        if (!container || !this.state) return;
        container.classList.remove('bg-x', 'bg-o');
        container.classList.add(this.state.current_mark === 'X' ? 'bg-x' : 'bg-o');
    }

    renderBoard() {
        const board = document.getElementById('ttt-board');
        if (!board || !this.state) return;

        board.innerHTML = this.state.board.map((cell, i) => {
            const taken = cell !== null;
            const markClass = cell === 'X' ? 'ttt-mark-x' : cell === 'O' ? 'ttt-mark-o' : '';
            const symbol = cell === 'X' ? '‚úï' : cell === 'O' ? '‚óã' : '';
            return `<div class="ttt-cell ${taken ? 'taken' : ''}" 
                        onclick="currentGame.handleCellClick(${i})"
                        data-cell="${i}">
                        <span class="ttt-mark ${markClass}">${symbol}</span>
                    </div>`;
        }).join('');
    }

    updatePlayers() {
        if (!this.state) return;
        const gamePlayers = this.state.players;
        document.getElementById('ttt-name-x').textContent = gamePlayers['X'];
        document.getElementById('ttt-name-o').textContent = gamePlayers['O'];
    }

    updateAvatarBubbles() {
        if (!this.state) return;
        const gamePlayers = this.state.players;

        // Set avatar images in bubbles
        if (typeof players !== 'undefined') {
            const pxData = players[gamePlayers['X']];
            const poData = players[gamePlayers['O']];
            if (pxData && pxData.gender) {
                const src = pxData.gender === 'female' ? '/static/games/icons/avatar_female.png' : '/static/games/icons/avatar_male.png';
                document.getElementById('ttt-bubble-img-x').innerHTML = `<img src="${src}" alt="avatar">`;
            }
            if (poData && poData.gender) {
                const src = poData.gender === 'female' ? '/static/games/icons/avatar_female.png' : '/static/games/icons/avatar_male.png';
                document.getElementById('ttt-bubble-img-o').innerHTML = `<img src="${src}" alt="avatar">`;
            }
        }

        // Active pulse on current turn's bubble
        document.getElementById('ttt-bubble-x').classList.toggle('active', this.state.current_mark === 'X');
        document.getElementById('ttt-bubble-o').classList.toggle('active', this.state.current_mark === 'O');
    }

    updateScores() {
        if (!this.state) return;
        const gamePlayers = this.state.players;
        const scores = this.state.scores;
        document.getElementById('ttt-score-x').textContent = scores[gamePlayers['X']] || 0;
        document.getElementById('ttt-score-o').textContent = scores[gamePlayers['O']] || 0;
        document.getElementById('ttt-round-info').textContent =
            `Round ${this.state.current_round}/${this.state.total_rounds}`;
    }

    updateTurnIndicator() {
        if (!this.state) return;
        const indicator = document.getElementById('ttt-turn-indicator');
        const textEl = document.getElementById('ttt-turn-text');
        const isMyTurn = this.isMyTurn();
        indicator.classList.toggle('my-turn', isMyTurn);
        textEl.textContent = isMyTurn ? "Your turn!" : "Opponent's turn...";
    }

    isMyTurn() {
        if (!this.state) return false;
        return this.state.players[this.state.current_mark] === USER;
    }

    handleCellClick(cellIndex) {
        // Wrong turn feedback with panda
        if (!this.isMyTurn()) {
            if (!this._wrongTurnCooldown) {
                this._wrongTurnCooldown = true;
                this.tttShowSpeech('notYourTurn');
                this.setPandaState('ttt-poked');
                setTimeout(() => {
                    this.setPandaState('thinking');
                    this._wrongTurnCooldown = false;
                }, 1200);
            }
            return;
        }
        if (this.state.board[cellIndex] !== null) return;
        if (this.state.paused) return;

        // Particles
        const cells = document.querySelectorAll('.ttt-cell');
        if (cells[cellIndex]) {
            const rect = cells[cellIndex].getBoundingClientRect();
            const color = this.state.current_mark === 'X' ? '#e74c3c' : '#3498db';
            for (let i = 0; i < 4; i++) {
                const p = document.createElement('div');
                p.className = 'ttt-particle';
                p.style.left = (rect.left + rect.width/2 + (Math.random()-0.5)*20) + 'px';
                p.style.top = (rect.top + rect.height/2) + 'px';
                p.style.backgroundColor = color;
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 2500);
            }
        }

        // Board shake
        const board = document.getElementById('ttt-board');
        if (board) {
            board.classList.add('shake');
            setTimeout(() => board.classList.remove('shake'), 400);
        }

        this.sendMove('place', { cell: cellIndex });
    }

    onRoundEnd(result) {
        const isWinner = result.round_winner === USER;
        const isDraw = result.round_winner === 'draw';

        if (isDraw) {
            this.setPandaState('ttt-sad');
            this.tttShowSpeech('draw');
        } else if (isWinner) {
            this.setPandaState('ttt-excited');
            this.tttShowSpeech('winSelf');
            this.createConfetti();
        } else {
            this.setPandaState('ttt-sad');
            this.tttShowSpeech('winOther');
        }

        // Highlight winning cells
        if (result.state && result.state.board) {
            const winPattern = this.findWinPattern(result.state.board);
            if (winPattern) {
                winPattern.forEach(idx => {
                    const cell = document.querySelector(`.ttt-cell[data-cell="${idx}"]`);
                    if (cell) cell.classList.add('winning');
                });
            }
        }

        const overlay = document.getElementById('ttt-result-overlay');
        const icon = document.getElementById('ttt-result-icon');
        const text = document.getElementById('ttt-result-text');
        const subtext = document.getElementById('ttt-result-subtext');

        if (isDraw) {
            icon.textContent = 'ü§ù';
            text.textContent = "It's a Draw!";
        } else if (isWinner) {
            icon.textContent = 'üèÜ';
            text.textContent = 'You Win!';
        } else {
            icon.textContent = 'üòî';
            text.textContent = 'You Lose!';
        }

        if (result.game_ended) {
            subtext.textContent = 'Returning to lobby...';
        } else {
            subtext.innerHTML = 'Next round in <span id="ttt-next-round-timer">3</span>...';
        }

        let delay = 0;
        if (result.reveal_at) delay = Math.max(0, result.reveal_at - Date.now());

        setTimeout(() => {
            overlay.style.display = 'flex';
            if (!result.game_ended) {
                let timeLeft = 3;
                const timerInterval = setInterval(() => {
                    timeLeft--;
                    const timerEl = document.getElementById('ttt-next-round-timer');
                    if (timerEl) timerEl.textContent = timeLeft;
                    if (timeLeft <= 0) clearInterval(timerInterval);
                }, 1000);
            }
            const displayMs = result.display_ms || 3000;
            setTimeout(() => {
                overlay.style.display = 'none';
                this.setPandaState('thinking');
            }, displayMs);
        }, delay);
    }

    onGameEnd(result) {
        const isWinner = result.game_winner === USER;
        const isDraw = result.game_winner === 'draw';

        if (isWinner) {
            this.setPandaState('ttt-excited');
            this.createConfetti();
        } else {
            this.setPandaState('ttt-sad');
        }

        const overlay = document.getElementById('ttt-result-overlay');
        const icon = document.getElementById('ttt-result-icon');
        const text = document.getElementById('ttt-result-text');
        const subtext = document.getElementById('ttt-result-subtext');

        if (isDraw) {
            icon.textContent = 'ü§ù';
            text.textContent = "Game Draw!";
        } else if (isWinner) {
            icon.textContent = 'üéâ';
            text.textContent = 'You Won the Game!';
        } else {
            icon.textContent = 'üòû';
            text.textContent = 'Game Over';
        }

        const scores = result.final_scores;
        if (scores) {
            const scoreText = Object.entries(scores).map(([p, s]) => `${p}: ${s}`).join(' - ');
            subtext.textContent = `Final: ${scoreText}`;
        }
        overlay.style.display = 'flex';
    }

    findWinPattern(board) {
        const patterns = [
            [0,1,2],[3,4,5],[6,7,8],
            [0,3,6],[1,4,7],[2,5,8],
            [0,4,8],[2,4,6]
        ];
        for (const p of patterns) {
            if (board[p[0]] && board[p[0]] === board[p[1]] && board[p[0]] === board[p[2]]) {
                return p;
            }
        }
        return null;
    }

    createConfetti() {
        const colors = ['#ff6b9d','#4fc3f7','#ffd700','#4a8f6d','#ff4778','#29b6f6','#e74c3c','#3498db'];
        for (let i = 0; i < 30; i++) {
            setTimeout(() => {
                const c = document.createElement('div');
                c.className = 'ttt-confetti';
                c.style.left = Math.random() * 100 + '%';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                c.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
                document.body.appendChild(c);
                c.addEventListener('animationend', () => c.remove());
            }, i * 40);
        }
    }

    showPauseOverlay() {
        document.getElementById('ttt-pause-overlay').style.display = 'flex';
        const disconnected = this.state.disconnected_players || [];
        if (disconnected.length > 0) {
            document.getElementById('ttt-disconnected-player').textContent = disconnected[0];
        }
    }

    hidePauseOverlay() {
        document.getElementById('ttt-pause-overlay').style.display = 'none';
    }

    updateCountdown(seconds) {
        document.getElementById('ttt-countdown').textContent = seconds;
    }
}

// Register game class
window.GameClasses = window.GameClasses || {};
window.GameClasses.tictactoe = TicTacToeGame;

// Exit game - send WebSocket event to return both players to lobby
window.exitGame = function() {
    if (confirm('Leave the game? Both players will return to lobby.')) {
        if (typeof socket !== 'undefined' && socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ event: 'game_exit' }));
        }
    }
};
</script>
