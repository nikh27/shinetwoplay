<!-- TicTacToe Game UI - Self-contained HTML + CSS + JS -->
<div class="ttt-container">
    <!-- Header with players and score -->
    <div class="ttt-header">
        <div class="ttt-player ttt-player-x" id="ttt-player-x">
            <div class="ttt-avatar" id="ttt-avatar-x">X</div>
            <span class="ttt-name" id="ttt-name-x">Player X</span>
        </div>
        
        <div class="ttt-score-center">
            <div class="ttt-round-info" id="ttt-round-info">Round 1/3</div>
            <div class="ttt-scores">
                <span class="ttt-score-x" id="ttt-score-x">0</span>
                <span class="ttt-score-divider">-</span>
                <span class="ttt-score-o" id="ttt-score-o">0</span>
            </div>
        </div>
        
        <div class="ttt-player ttt-player-o" id="ttt-player-o">
            <div class="ttt-avatar" id="ttt-avatar-o">O</div>
            <span class="ttt-name" id="ttt-name-o">Player O</span>
        </div>
    </div>
    
    <!-- Turn indicator -->
    <div class="ttt-turn-indicator" id="ttt-turn-indicator">
        <span id="ttt-turn-text">Your turn!</span>
    </div>
    
    <!-- Game board -->
    <div class="ttt-board" id="ttt-board">
        <!-- Cells will be generated by JS -->
    </div>
    
    <!-- Messages toggle button (corner) -->
    <button class="ttt-chat-toggle" id="ttt-chat-toggle" onclick="toggleGameMessages()">
        üí¨
        <span class="ttt-chat-badge" id="ttt-chat-badge" style="display:none;">0</span>
    </button>

    <!-- Messages panel with simple text input -->
    <div class="ttt-msg-panel" id="ttt-msg-panel">
        <div class="ttt-msg-header">
            <span class="ttt-msg-title">Messages</span>
            <button class="ttt-msg-close" onclick="toggleGameMessages()">‚úï</button>
        </div>
        <div class="ttt-msg-list" id="ttt-msg-list">
            <div class="ttt-msg-empty" id="ttt-msg-empty">No messages yet</div>
        </div>
        <div class="ttt-msg-input-area">
            <input type="text" class="ttt-msg-input" id="ttt-msg-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendGameMessage()">
            <button class="ttt-msg-send" onclick="sendGameMessage()">‚û§</button>
        </div>
    </div>
    
    <!-- Pause overlay (shown when opponent disconnects) -->
    <div class="ttt-pause-overlay" id="ttt-pause-overlay" style="display:none;">
        <div class="ttt-pause-content">
            <div class="ttt-pause-icon">‚è∏Ô∏è</div>
            <h3>Game Paused</h3>
            <p>Waiting for <strong id="ttt-disconnected-player">opponent</strong> to reconnect...</p>
            <div class="ttt-countdown" id="ttt-countdown">30</div>
            <p class="ttt-countdown-label">seconds</p>
        </div>
    </div>
    
    <!-- Round result overlay -->
    <div class="ttt-result-overlay" id="ttt-result-overlay" style="display:none;">
        <div class="ttt-result-content">
            <div class="ttt-result-icon" id="ttt-result-icon">üèÜ</div>
            <h2 id="ttt-result-text">You Win!</h2>
            <p id="ttt-result-subtext">Next round starting...</p>
        </div>
    </div>
</div>

<style>
/* TicTacToe Styles - Scoped to .ttt-container */
.ttt-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    max-width: 400px;
    margin: 0 auto;
    position: relative;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Header */
.ttt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 20px;
    gap: 15px;
}

.ttt-player {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    opacity: 0.6;
    transition: opacity 0.3s, transform 0.3s;
}

.ttt-player.active {
    opacity: 1;
    transform: scale(1.05);
}

.ttt-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    color: white;
}

.ttt-player-x .ttt-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.ttt-player-o .ttt-avatar {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.ttt-name {
    font-size: 12px;
    font-weight: 600;
    color: #333;
    max-width: 80px;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

/* Score center */
.ttt-score-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.ttt-round-info {
    font-size: 12px;
    color: #666;
    font-weight: 500;
}

.ttt-scores {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 24px;
    font-weight: bold;
}

.ttt-score-x { color: #667eea; }
.ttt-score-o { color: #f5576c; }
.ttt-score-divider { color: #ccc; }

/* Turn indicator */
.ttt-turn-indicator {
    margin-bottom: 15px;
    padding: 8px 20px;
    border-radius: 20px;
    background: #f0f0f0;
    font-size: 14px;
    font-weight: 500;
    color: #333;
    transition: background 0.3s;
}

.ttt-turn-indicator.my-turn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

/* Game Board */
.ttt-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    background: #333;
    padding: 8px;
    border-radius: 12px;
}

.ttt-cell {
    width: 90px;
    height: 90px;
    background: #fff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    user-select: none;
}

.ttt-cell:hover:not(.taken) {
    background: #f5f5f5;
    transform: scale(1.02);
}

.ttt-cell.taken {
    cursor: not-allowed;
}

.ttt-cell .ttt-mark-x {
    color: #667eea;
}

.ttt-cell .ttt-mark-o {
    color: #f5576c;
}

.ttt-cell.winning {
    animation: pulse 0.5s ease infinite;
    background: #e8ffe8;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Messages toggle button */
.ttt-chat-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform 0.2s;
    z-index: 200;
}

.ttt-chat-toggle:hover {
    transform: scale(1.1);
}

.ttt-chat-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #f5576c;
    color: white;
    font-size: 12px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ===== Messages-Only Panel ===== */
.ttt-msg-panel {
    position: fixed;
    top: 0;
    right: -100%;
    width: 85%;
    max-width: 320px;
    height: 100%;
    background: #fff;
    box-shadow: -4px 0 24px rgba(0,0,0,0.18);
    z-index: 190;
    display: flex;
    flex-direction: column;
    transition: right 0.3s ease;
    border-radius: 16px 0 0 16px;
}

.ttt-msg-panel.open {
    right: 0;
}

.ttt-msg-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px 0 0 0;
    flex-shrink: 0;
}

.ttt-msg-title {
    font-size: 16px;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.5px;
}

.ttt-msg-close {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.2);
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.ttt-msg-close:hover {
    background: rgba(255,255,255,0.35);
}

.ttt-msg-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ttt-msg-empty {
    color: #aaa;
    text-align: center;
    margin-top: 40px;
    font-size: 14px;
    font-style: italic;
}

/* Individual message bubble */
.ttt-msg-item {
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.4;
    max-width: 90%;
    word-wrap: break-word;
}

.ttt-msg-item.own {
    background: linear-gradient(135deg, #667eea22, #764ba222);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.ttt-msg-item.other {
    background: #f5f5f5;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.ttt-msg-item.system {
    background: #fff8e1;
    align-self: center;
    font-size: 12px;
    color: #888;
    font-style: italic;
    text-align: center;
}

.ttt-msg-sender {
    font-size: 11px;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 2px;
}

.ttt-msg-item.own .ttt-msg-sender {
    color: #764ba2;
    text-align: right;
}

.ttt-msg-text {
    color: #333;
}

.ttt-msg-time {
    font-size: 10px;
    color: #aaa;
    margin-top: 2px;
}

.ttt-msg-item.own .ttt-msg-time {
    text-align: right;
}

/* Input area */
.ttt-msg-input-area {
    display: flex;
    gap: 8px;
    padding: 10px 12px;
    border-top: 1px solid #eee;
    background: #fafafa;
    border-radius: 0 0 0 16px;
    flex-shrink: 0;
}

.ttt-msg-input {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 14px;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    font-family: inherit;
}

.ttt-msg-input:focus {
    border-color: #667eea;
}

.ttt-msg-send {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    flex-shrink: 0;
}

.ttt-msg-send:hover {
    transform: scale(1.1);
}

/* Overlays */
.ttt-pause-overlay,
.ttt-result-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    z-index: 50;
}

.ttt-pause-content,
.ttt-result-content {
    text-align: center;
    color: white;
}

.ttt-pause-icon,
.ttt-result-icon {
    font-size: 60px;
    margin-bottom: 15px;
}

.ttt-countdown {
    font-size: 48px;
    font-weight: bold;
    color: #f5576c;
}

.ttt-countdown-label {
    font-size: 14px;
    color: #aaa;
}

.ttt-result-content h2 {
    font-size: 28px;
    margin: 10px 0;
}

.ttt-result-content p {
    color: #aaa;
    font-size: 14px;
}
</style>

<script>
// TicTacToe Game Class - Extends BaseGame from room.html
class TicTacToeGame extends BaseGame {
    constructor() {
        super();
        this.gameMode = "turn_based";
    }
    
    init(state) {
        this.state = state;
        this.renderBoard();
        this.updatePlayers();
        this.updateScores();
        this.updateTurnIndicator();
    }
    
    update(state) {
        this.state = state;
        this.renderBoard();
        this.updatePlayers();
        this.updateScores();
        this.updateTurnIndicator();
        
        // Handle pause state
        if (state.paused) {
            this.showPauseOverlay();
        } else {
            this.hidePauseOverlay();
        }
    }
    
    renderBoard() {
        const board = document.getElementById('ttt-board');
        board.innerHTML = this.state.board.map((cell, i) => {
            const taken = cell !== null;
            const markClass = cell === 'X' ? 'ttt-mark-x' : cell === 'O' ? 'ttt-mark-o' : '';
            const symbol = cell === 'X' ? '‚úï' : cell === 'O' ? '‚óã' : '';
            
            return `<div class="ttt-cell ${taken ? 'taken' : ''}" 
                        onclick="currentGame.handleCellClick(${i})"
                        data-cell="${i}">
                        <span class="${markClass}">${symbol}</span>
                    </div>`;
        }).join('');
    }
    
    updatePlayers() {
        const players = this.state.players;
        const currentMark = this.state.current_mark;
        
        // Update names
        document.getElementById('ttt-name-x').textContent = players['X'];
        document.getElementById('ttt-name-o').textContent = players['O'];
        
        // Update active state
        document.getElementById('ttt-player-x').classList.toggle('active', currentMark === 'X');
        document.getElementById('ttt-player-o').classList.toggle('active', currentMark === 'O');
    }
    
    updateScores() {
        const players = this.state.players;
        const scores = this.state.scores;
        
        document.getElementById('ttt-score-x').textContent = scores[players['X']] || 0;
        document.getElementById('ttt-score-o').textContent = scores[players['O']] || 0;
        document.getElementById('ttt-round-info').textContent = 
            `Round ${this.state.current_round}/${this.state.total_rounds}`;
    }
    
    updateTurnIndicator() {
        const indicator = document.getElementById('ttt-turn-indicator');
        const textEl = document.getElementById('ttt-turn-text');
        const isMyTurn = this.isMyTurn();
        
        indicator.classList.toggle('my-turn', isMyTurn);
        textEl.textContent = isMyTurn ? "Your turn!" : "Opponent's turn...";
    }
    
    isMyTurn() {
        const currentMark = this.state.current_mark;
        const currentPlayer = this.state.players[currentMark];
        return currentPlayer === USER;
    }
    
    handleCellClick(cellIndex) {
        // Validate it's my turn and cell is empty
        if (!this.isMyTurn()) return;
        if (this.state.board[cellIndex] !== null) return;
        if (this.state.paused) return;
        
        // Send move to server
        this.sendMove('place', { cell: cellIndex });
    }
    
    onRoundEnd(result) {
        const isWinner = result.round_winner === USER;
        const isDraw = result.round_winner === 'draw';
        
        
        const overlay = document.getElementById('ttt-result-overlay');
        const icon = document.getElementById('ttt-result-icon');
        const text = document.getElementById('ttt-result-text');
        const subtext = document.getElementById('ttt-result-subtext');
        
        if (isDraw) {
            icon.textContent = 'ü§ù';
            text.textContent = "It's a Draw!";
        } else if (isWinner) {
            icon.textContent = 'üèÜ';
            text.textContent = 'You Win!';
        } else {
            icon.textContent = 'üòî';
            text.textContent = 'You Lose!';
        }
        
        
        
        if (result.game_ended) {
            subtext.textContent = 'Returning to lobby...';
        } else {
            subtext.innerHTML = 'Next round in <span id="ttt-next-round-timer">3</span>...';
        }
        
        // Calculate delay for synchronized reveal
        let delay = 0;
        if (result.reveal_at) {
            delay = Math.max(0, result.reveal_at - Date.now());
        }
        
        // Show after delay
        setTimeout(() => {
            overlay.style.display = 'flex';
            
            // Start countdown animation only when overlay shows
            if (!result.game_ended) {
                let timeLeft = 3;
                const timerInterval = setInterval(() => {
                    timeLeft--;
                    const timerEl = document.getElementById('ttt-next-round-timer');
                    if (timerEl) timerEl.textContent = timeLeft;
                    if (timeLeft <= 0) clearInterval(timerInterval);
                }, 1000);
            }
            
            // Use server-provided timestamp for synchronized hide timing
            const displayMs = result.display_ms || 3000;
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, displayMs);
            
        }, delay);
    }
    
    onGameEnd(result) {
        const isWinner = result.game_winner === USER;
        const isDraw = result.game_winner === 'draw';
        
        const overlay = document.getElementById('ttt-result-overlay');
        const icon = document.getElementById('ttt-result-icon');
        const text = document.getElementById('ttt-result-text');
        const subtext = document.getElementById('ttt-result-subtext');
        
        if (isDraw) {
            icon.textContent = 'ü§ù';
            text.textContent = "Game Draw!";
        } else if (isWinner) {
            icon.textContent = 'üéâ';
            text.textContent = 'You Won the Game!';
        } else {
            icon.textContent = 'üò¢';
            text.textContent = 'Game Over';
        }
        
        const scores = result.final_scores;
        const scoreText = Object.entries(scores).map(([p, s]) => `${p}: ${s}`).join(' - ');
        subtext.textContent = `Final: ${scoreText}`;
        
        overlay.style.display = 'flex';
        
        // Use server timestamp - result stays visible until game_ended handler closes overlay
    }
    
    showPauseOverlay() {
        document.getElementById('ttt-pause-overlay').style.display = 'flex';
        const disconnected = this.state.disconnected_players || [];
        if (disconnected.length > 0) {
            document.getElementById('ttt-disconnected-player').textContent = disconnected[0];
        }
    }
    
    hidePauseOverlay() {
        document.getElementById('ttt-pause-overlay').style.display = 'none';
    }
    
    updateCountdown(seconds) {
        document.getElementById('ttt-countdown').textContent = seconds;
    }
}

// Register this game class
window.GameClasses = window.GameClasses || {};
window.GameClasses.tictactoe = TicTacToeGame;

// ===== Messages Panel Logic =====

// Track unread count
window._gameMsgUnread = 0;
window._gameMsgPanelOpen = false;

// Format time from ISO string
function _fmtTime(ts) {
    if (!ts) return '';
    const d = new Date(ts);
    const h = d.getHours().toString().padStart(2, '0');
    const m = d.getMinutes().toString().padStart(2, '0');
    return `${h}:${m}`;
}

// Escape HTML
function _escHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

// Add a message to the panel
function addGamePanelMessage(msg) {
    const list = document.getElementById('ttt-msg-list');
    if (!list) return;

    // Remove "No messages" placeholder
    const empty = document.getElementById('ttt-msg-empty');
    if (empty) empty.remove();

    const div = document.createElement('div');

    if (msg.type === 'system') {
        div.className = 'ttt-msg-item system';
        div.innerHTML = `<div class="ttt-msg-text">${_escHtml(msg.content)}</div>`;
    } else {
        const isOwn = msg.sender === USER;
        div.className = `ttt-msg-item ${isOwn ? 'own' : 'other'}`;
        const senderName = isOwn ? 'You' : msg.sender;
        div.innerHTML = `
            <div class="ttt-msg-sender">${_escHtml(senderName)}</div>
            <div class="ttt-msg-text">${_escHtml(msg.content || '')}</div>
            <div class="ttt-msg-time">${_fmtTime(msg.timestamp)}</div>
        `;
    }

    list.appendChild(div);
    list.scrollTop = list.scrollHeight;
}

// Send a message from game panel (uses the room's WebSocket)
window.sendGameMessage = function() {
    const input = document.getElementById('ttt-msg-input');
    if (!input) return;
    const message = input.value.trim();
    if (!message) return;

    // Use the room's socket to send
    if (typeof socket !== 'undefined' && socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ event: 'chat', msg: message }));
    }
    input.value = '';
}

// Toggle the messages panel open/close
window.toggleGameMessages = function() {
    const panel = document.getElementById('ttt-msg-panel');
    if (!panel) return;

    window._gameMsgPanelOpen = !window._gameMsgPanelOpen;

    if (window._gameMsgPanelOpen) {
        panel.classList.add('open');
        // Clear badge
        window._gameMsgUnread = 0;
        const badge = document.getElementById('ttt-chat-badge');
        if (badge) badge.style.display = 'none';
        // Focus input
        const input = document.getElementById('ttt-msg-input');
        if (input) setTimeout(() => input.focus(), 200);
    } else {
        panel.classList.remove('open');
    }
}

// Attach toggle on button (safety)
setTimeout(() => {
    const btn = document.getElementById('ttt-chat-toggle');
    if (btn) btn.onclick = window.toggleGameMessages;
}, 500);

// Register callback for game chat messages (called from room.html's displayMessage)
window.onGameChatMessage = function(msg) {
    // Push message into game panel
    addGamePanelMessage(msg);

    // Show badge if panel is closed and not own message
    if (!window._gameMsgPanelOpen && msg.sender !== USER) {
        window._gameMsgUnread++;
        const badge = document.getElementById('ttt-chat-badge');
        if (badge) {
            badge.style.display = 'flex';
            badge.textContent = window._gameMsgUnread > 9 ? '9+' : window._gameMsgUnread;
        }
    }
};
</script>
